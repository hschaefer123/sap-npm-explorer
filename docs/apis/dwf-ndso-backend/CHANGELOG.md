# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/en/1.0.0/)
and this project adheres to [Semantic Versioning](http://semver.org/spec/v2.0.0.html).

## [Unreleased]
nothing yet

## [2.2.0] - 2018-08-15
### Changed
- addSubscriber and resetSubscriber operations now fail if there is no change
  log modeled
- changed expected metamodel version for generated NDSOs from 1.2.0 to 2.0.0.

  While the metamodel itself does not contain incompatible changes,
  previously deployed NDSOs won't be operable after upgrading the metdamodel
  and require manual migration. This is intended but from the user's perspective
  a breaking change which shall be reflected by a new major version according to
  semver
- getMetadata now also returns typeParam1, typeParam2 and defaultValue for
  active data fields

### Fixed
- Fix storeCSV to only ignore actually empty rows (before, it also filtered
  those only containing special characters). Also made check for line-endings
  agnostic of the operating system

## [2.1.0] - 2018-07-06
### Added
- Generated NDSOs are supported
- Enhance metadata object to include sequence, procedures and metamodel information
- Support generated synonyms (`DataWarehouse.DataStore` namespace) for DB objects
- Implemented checkMetadataConsistency task

### Changed
- Added to operation storeSQL default handling for `NULL` values in columns
  defined as `TIMESTAMP`

### Fixed
- Fix storeCSV to ignore empty lines

## [2.0.2] - 2018-04-17
### Fixed
- Fix getRequestsFor*Deletion* to still provide loads if multiple loads are done
  before a partial activation (before, the remaining loads were not returned)

## [2.0.1] - 2018-04-16
### Fixed
- Fix getRequestsForActivation to still provide loads if multiple loads are done
  before a partial activation (before, the remaining loads were not returned)
- Fix repairRunningOperations to update lastTimestamp column in the
  operationHistory table
- Fix start messages for add-, reset- and removeSubscriber (showed '{0}' instead
  of subscriber name)

## [2.0.0] - 2018-04-13
### Added
- complete NDSO task reference on README (generated by
  [`jsdoc-to-markdown`](https://www.npmjs.com/package/jsdoc-to-markdown))
- support more [query options](./README.md#queryoptions)

### Changed
- **Incompatible:** Rewrite task getOperationInfo to now take generic query
  options instead of dedicated filter parameters
- **Incompatible:** Rewrite tasks getRowcountWithFilter and deleteWithFilter
  to now filter by generic query options instead of using a provided where
  clause
- **Incompatible:** added default handling to operation storeSQL if the source
  data contains `NULL` values. This required to explicitly list the columns in
  the underlying SQL statement which effectively means, that the provided SQL
  serving as `FROM` clause needs to provide the exact same column names as the
  corresponding inbound queue has. As that was not required before, old
  statements may not work anymore
- deleteWithFilter now writes `filter` instead of `where` into operationDetails
- Lists of request IDs are now shortened for more than 5 requests in log and
  tracing messages (affects, for example, activate and rollback operations)
- cleanupChangelog now writes `requestCount` and `requestList` into
  operationDetails. `requestList` is shortened the same way as log entries
- Reworked log messages (e.g. expanded 'lines' suffix by a dedicated detail
  message listing how many rows have been inserted, updated, deleted as it has
  been only for activate and rollback before)
- cleanupChangelog is now rejected without writing an operation when run on NDSO
  without change log
- Minor performance improvement for getMetadata
- Minor improvement of CSV checks (removes empty semicolons and final line breaks)

### Fixed
- Fix getRequestsForActivation and getRequestsForDeletion to also consider
  running activations/deletions (the affected load requests are not returned
  anymore)
- Fix getRequestsForActivation to not fail without maxRequestId
- Fix getRequestsForDeletion to also provide failed loads before last activation
- Fix getRequestsForCleanup to also consider running rollbacks/clean-ups
  (the affected activation requests are not returned anymore)
- Fix getRequestsForRollback to exclude requests that have been extracted by
  subscribers as rollbacks are just deleted from change log
- Fix rollback for aggregation-related model changes. Before, when activating
  with a `SUM` aggregation, then changing the model e.g. to a `MOV` aggregation
  a rollback would not treat the before-image as negated because that
  information was taken from active data, not the aggregation history. As a
  result, data was likely corrupted after such a rollback
- Fix deleteWithFilter to also write aggregation history if called with
  `propagateDeletion`. In combination with the fix for rollback, this would have
  resulted in data corruption after rollback of a deletion
- Fix operation timestamps by updating the operation status once more before the
  final commit

### Removed
- Remove checksum handling; hashes are neither verified nor updated anymore
- Remove setConfig as there was no supported global config anymore anyway
- Remove dependency to [`async`](https://www.npmjs.com/package/async)

## [1.4.0] - 2018-02-06
### Added
- Promise support by all tasks (just omit callback to use it)
- storeCSV now supports NDSOs with binary types (`VARBINARY` and `BLOB`). To
  utilize this, provide data as hexadecimal strings, data is inserted via
  `HEXTOBIN` SQL function

### Changed
- **Incompatible:** queryOption 'ord' now array as order is relevant and object
  property order is unspecified
- queryOption 'flt' now supports multiple values. Refer to [README](./README.md)
  for details
- deleteWithFilter now writes `where` instead of `sWhere` into operationDetails
- Slight performance improvement overall by caching repeatedly retrieved
  metadata
- Complete refactoring of smokeTest, increasing coverage and significantly
  improving performance
- getDatastoreFeature now checks for existence of NDSO meta model instead of a
  runtime environment variable. It also returns the meta model version
- getMetadata now returns `defaultValue`s for inbound queue fields

### Removed
- setConfig option `earlyCallback`

## [1.3.1] - 2017-12-18
### Fixed
- Fix timeout issue in smokeTest

## [1.3.0] - 2017-12-15
### Changed
- **Incompatible**: Remove custom format `YYYYMMDDHH24MISS` for timestamps,
  now ISO 8601 UTC strings (`YYYY-MM-DD"T"HH24:MI:SS.FF3"Z"`)
  are sent and expected for filtering
- **Incompatible**: Rewrite task getRequestInfo:
  - now takes generic query options instead of multiple query parameters
  - returns flat array as result instead of splitting loads and activations
  - fix typo in `dependentRequests` property
  - significant performance improvement by pushing whole logic to HANA

### Deprecated
- setConfig option `earlyCallback` shall not be used anymore and will be removed
  soon.

## [1.2.0] - 2017-12-12
### Added
- Add new task getMonitoringOverview that fetches all NDSOs of the provided
  schema and provides information relevant for monitoring, like the last
  operation and stats like table sizes and row count.

  Note that the latter requires access to the monitoring views `SYS.M_CS_TABLE`
  and `SYS.M_RS_TABLE`.
- Add queryOptions to task getDataStores which support filtering, sorting and
  paging. Refer to [README](./README.md) for details
- Add support for drawing request IDs from sequence.

  To do so the sequence must be named as annotation
  `@DataStore.sequence: 'name with namespace'`. When introducing a sequence for
  existing NDSOs, you should define `RESET BY` according to the maximum value
  in the `idGenerator` table. Note that that table will continue to be updated
  even if IDs are drawn by sequence.

### Changed
- Provide detail message with modified rows after operations activate and
  rollback also for alternative client `@sap/hana-client`
- Write application user into metadata tables, if available (falls back to the
  technical `CURRENT_USER` if not)

### Fixed
- Fix crash in getOperationsForRequest if no operation found (may happen during
  deleteAll)
- Fix message logging for failed operations. It used to throw an error like
  'statement.execBatch undefined'

## [1.1.1] - 2017-11-20
### Fixed
- Fix getRequestsForActivation to return multiple requests again
- Fix activation for multiple inbound queues
- Fix logging of activation procedure parameters (was missing change log
  info)

## [1.1.0] - 2017-11-07
### Added
- Support for alternative HANA client `@sap/hana-client`

### Changed
- Improve log for activate/rollback: procedure result is now added as proper
  log messages, not technical JSON (only for `node-hdb` client)
- Use most recent version of `async`

### Fixed
- Follow-up fix of error handling if operation cannot be started
- Fix rollback error if previous rollback failed

## [1.0.5] - 2017-10-24
### Changed
- operation status of checkMetadataConsistency now reflects consistency result,
  i.e., if there is an error the operation status will be FAILED
- getRowcountWithFilter can now be called without the superfluous second DB
  client, i.e., with `tracer, client, schema, ndso, whereClause, callback`.
  The signature stays compatible though, the second client is just optional

### Fixed
- Fix smokeTest status polling which exited too early because smokeTest uses
  the same DB connections for all operations and therefore sees status
  'FINISHED' before it is committed. Now it polls for an internal indicator
  instead
- Fix error handling if operation cannot be started (e.g. called with not
  existing NDSO name)
- Fix repairRunningOperations. It used to check the runningOperations entity
  but with introduction of startOperation that is written in the first commit
  without locking again. The repair operation now checks the operationHistory
  instead because the status update is the first update after the first commit.

## [1.0.4] - 2017-10-13
### Changed
- Close database connections for operations when `earlyCallback` is active
- Improve README.md

## [1.0.3] - 2017-10-12
### Fixed
- Fix task smokeTest to also support `earlyCallback` option. It used to return
  immediately, so the still running operations could interfere with test
  clean-up procedures

## [1.0.2] - 2017-10-11
### Fixed
- Fix number of written lines in various operation success messages
- Fix list of deletable load requests (task getRequestsForDeletion); used to
  return also activated and already deleted load requests
- Fix list of requests for rollback (task getRequestsForRollback); used to
  return also requests that the change log has meanwhile been cleared for
  (resulted in technical error during rollback: 'Unique constraint violation')

## [1.0.1] - 2017-10-06
### Added
- Add CHANGELOG.md (this file) and publishable README.md
- Add new task `setConfig` that allows to set options by a key-value object.

  Currently, only option `earlyCallback` is supported which makes operations
  call the main callback function already after drawing IDs and writing the
  operation into the history. This fixes various timeout issues when executing
  operations in the HRTT Manage UI.

### Fixed
- Fix side-effect of disabling autocommit. In case of errors also the
  affectedRequests entity was rolled back which resulted in an inconsistency and,
  for example, failing load or activation requests were not shown on the UI.
- Fix checksum calculation for LargeBinary (BLOB) fields as casting to VARCHAR
  is invalid. As a result such NDSOs could not be activated.

## [1.0.0] - 2017-09-29
### Added
- First release of this package; based on code from @sap/dwf-dws-client and
  the Database Explorer (HANA Runtime Tools, HRTT)

### Changed
- Exclude internal helpers from the `tasks` folder which now only contains
  real tasks to be invoked by a consumer

### Fixed
- Fix checksum handling in task CheckMetadataConsistency. It now works like the
  check on Activate.
